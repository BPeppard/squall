/*
 Storming 2014-12-19 
*/
function draw(){var a=fragmentText($(".textBox").text(),.8*canvas.width),b=18;$("#textCanvas").attr("width",$(".panel-body").width()),$("#textCanvas").attr("height",a.length*(b+5)+100),context.clearRect(0,0,canvas.width,canvas.height),context.rect(0,0,canvas.width,canvas.height),context.fillStyle="#ffffff",context.fill(),context.font=b+"px sans-serif",context.textBaseline="top",context.fillStyle="#333333",a.forEach(function(a,c){context.fillText(a,.1*canvas.width,(c+1)*(b+5))}),checked&&context.fillText(credit_text,canvas.width-emmeasure*credit_text.length-40,canvas.height-(b+10)),document.getElementById("image").src=context.canvas.toDataURL(),context.restore()}function fragmentText(a,b){function c(a,b){var c=a.length;if(0===c)return[];if(1===c)return[a];for(var d=[],e="",f=0,g=[],h=0;c>h;h++)g.push({letter:a[h],measure:context.measureText(a[h]).width});for(var i in g){var j=g[i];f+j.measure>b&&(d.push({word:e,len:e.length,measure:f}),e="",f=0),e+=j.letter,f+=j.measure}return d.push({word:e,len:e.length,measure:f}),d}if(emmeasure>b)throw"Can't fragment less than one character.";if(context.measureText(a).width<b)return[a];var d=a.split(" "),e=[],f=[];for(var g in d){var h=d[g],i=context.measureText(h).width;if(i>b){var j=c(h,b);for(var k in j)e.push(j[k])}else e.push({word:h,len:h.length,measure:i})}var l="",m=0;for(var n in e){var o=e[n];m+o.measure>b&&m>0&&o.len>1&&(f.push(l),l="",m=0),l+=o.word,m+=o.measure,b>m+spacemeasure?(l+=" ",m+=spacemeasure):(f.push(l),l="",m=0)}return m>0&&f.push(l),f}var canvas=document.getElementById("textCanvas"),context=canvas.getContext("2d"),emmeasure=context.measureText("M").width,spacemeasure=context.measureText(" ").width,checked=!0,credit_text="Tweeted using Storming.ME",TCO_LENGTH=23,IMAGE_LINK_LENGTH=23;$(".login-btn").click(function(){ga("send","event","Homepage","click","Login")}),$(".example-btn").click(function(){ga("send","event","Homepage","click","Example")}),$(".why-btn").click(function(){ga("send","event","Homepage","click","Why Medium")}),$("#textCanvas").attr("width",$(".panel-body").width()),$(".textBox").keyup(function(){draw()}),$(window).resize(function(){draw()}),$(".tweet-button").click(function(){$(".tweet-button").text("Posting your tweetstorm..."),$(".tweetresult").css("display","none"),ga("send","event","Dashboard","Click","Tweet",$(".textBox").text().length),$.post("/tweet",{image:$("#image").attr("src"),message:$("#textArea").val()},function(a){console.log(a),$(".tweetresult").css("display","block"),$(".tweetresult").find(".embed").html(a),$(".tweet-button").text("Post Tweetstorm as Picture")})}),$("#credit").click(function(){var a=$(this);checked=a.is(":checked"),checked?$(".textBox").after('<div class="credit-preview">'+credit_text+"</div>"):$(".panel-body").find(".credit-preview").remove(),draw()}),$("#textArea").keyup(function(){var a=$(this).val(),b=a.split(" ");geturl=new RegExp("(^|[ 	\r\n])((ftp|http|https|gopher|mailto|news|nntp|telnet|wais|file|prospero|aim|webcal):(([A-Za-z0-9$_.+!*(),;/?:@&~=-])|%[A-Fa-f0-9]{2}){2,}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*(),;/?:@&~=%-]*))?([A-Za-z0-9$_+!*();/?:~-]))","g");for(var c=0,d=0;d<b.length;d++)c+=b[d].match(geturl)&&b[d].length>TCO_LENGTH?TCO_LENGTH:b[d].length;$(".text-length").text(IMAGE_LINK_LENGTH+c+"/140")});